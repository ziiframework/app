name: Zii-CI

on:
  push:
    branches: [ master ]

  pull_request:
    branches: [ master ]

jobs:
  localstack:
    name: PHP-7.4 MySql-8.0 Nginx-1.19
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    container: charescape/web:3.0.4
    steps:
      - uses: actions/checkout@v2

      - name: Composer Install
        run: |
          rm composer.lock
          /usr/local/php/bin/php /usr/local/bin/composer.phar install --prefer-dist --no-interaction --optimize-autoloader

      - name: Directory Setup
        run: |
          chmod -R 777 ./runtime
          chmod -R 644 ./runtime/.gitignore

      - name: Copy Directory
        run: |
          /bin/cp ./web/index-test.php ./web/index.php
          cp -r ../app /var/www/yiitest
          chown -R www-data:www-data /var/www/

      - name: Start Service
        run: |
          /etc/my_init.d/runapp.sh
          echo '127.0.0.1 app.yiitest.com' >> /etc/hosts

      - name: Check Service Ready
        run: |
          ps -aux | grep mysql
          ps -aux | grep php
          ps -aux | grep nginx

      - name: Import Sql Files
        run: |
          /usr/local/mysql/bin/mysql -uroot -proot12345 testdb0 < ./tests/_data/init.sql

      - name: Database Migration
        run: |
          /usr/local/php/bin/php ./yii-test migrate/up --interactive=0

      - name: Codeception Cest
        run: /usr/local/php/bin/php vendor/bin/codecept run --steps
