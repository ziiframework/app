name: Zii-CI

on:
  push:
    branches: [ master ]

  pull_request:
    branches: [ master ]

jobs:
  fullstack:
    name: PHP 7.4 on Ubuntu 20.04
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    container: charescape/web:3.0.3
    steps:
      - uses: actions/checkout@v2
      - name: Setup env
        run: |
          echo '127.0.0.1 app.zii.com' >> /etc/hosts
          echo 'pwd' && pwd
          echo 'ls' && ls
          /bin/cp  test/_nginx/nginx.conf  /usr/local/nginx/conf/nginx.conf
          echo 'reload nginx' && nginx -t && nginx -s reload

      - name: Composer Install
        run: |
          rm composer.lock
          composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: Directory Setup
        run: |
          chmod -R 777 ./runtime
          chmod -R 644 ./runtime/.gitignore

      - name: Codeception
        run: vendor/bin/codecept run --steps
